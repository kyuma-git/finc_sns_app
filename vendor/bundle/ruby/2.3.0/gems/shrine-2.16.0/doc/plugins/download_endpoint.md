# Download Endpoint

The [`download_endpoint`][download_endpoint] plugin provides a Rack app for
downloading uploaded files from specified storages. This can be useful when
files from your storage isn't accessible over URL (e.g. database storages) or
if you want to authenticate your downloads. It requires the [Roda] gem.

```rb
# Gemfile
gem "roda" # dependency of the download_endpoint plugin
```

You can configure the plugin with the path prefix which the endpoint will be
mounted on.

```rb
plugin :download_endpoint, prefix: "attachments"
```

The endpoint should then be mounted on the specified prefix:

```rb
# config.ru (Rack)
map "/attachments" do
  run Shrine.download_endpoint
end

# OR

# config/routes.rb (Rails)
Rails.application.routes.draw do
  mount Shrine.download_endpoint => "/attachments"
end
```

Any uploaded file can be downloaded through this endpoint. When a file is
requested, its content will be efficiently streamed from the storage into the
response body.

Links to the download endpoint are generated by calling
`UploadedFile#download_url` instead of the usual `UploadedFile#url`.

```rb
uploaded_file.download_url #=> "/attachments/eyJpZCI6ImFkdzlyeTM..."
```

## Host

You can specify download URL host via the `:host` plugin option:

```rb
plugin :download_endpoint, host: "http://example.com"
```

or by passing `:host` to `UploadedFile#download_url`:

```rb
uploaded_file.download_url(host: "http://example.com")
#=> "http//example.com/attachments/eyJpZCI6ImFkdzlyeTM..."
```

## Download options

If you want to pass additional options to `Storage#open`, you can do so via
`:download_options`:

```rb
plugin :download_endpoint, download_options: {
  sse_customer_algorithm: "AES256",
  sse_customer_key:       "secret_key",
  sse_customer_key_md5:   "secret_key_md5",
}
```

You can also specify a proc to generate download options dynamically:

```rb
plugin :download_enpdoint, download_options: -> (uploaded_file, request) {
  {
    sse_customer_algorithm: "AES256",
    sse_customer_key:       "secret_key",
    sse_customer_key_md5:   "secret_key_md5",
  }
}
```

## Performance considerations

Streaming files through the app might impact the request throughput, depending
on the web server you're using. So it's recommended to use a CDN, which can be
set via the `:host` option.

Alternatively, you can have the endpoint redirect to the direct file URL:

```rb
plugin :download_endpoint, redirect: true
```

You can also specify a proc to generate your own redirect URL:

```rb
plugin :download_endpoint, redirect: -> (uploaded_file, request) do
  uploaded_file.url(public: true)
end
```

## Custom endpoint

If you want to have more control on download requests, you can use the
`rack_response` plugin which this plugin uses internally.

## Plugin options

| Name                | Description                                                                       | Default  |
| :--------           | :----------                                                                       | :------  |
| `:disposition`      | Whether browser should render the file `inline` or download it as an `attachment` | `inline` |
| `:download_options` | Hash of storage-specific options passed to `Storage#open`                         | `{}`     |
| `:host`             | URL host that will be added to download URLs                                      | `nil`    |
| `:prefix`           | Path prefix prepended to download URLs                                            | `nil`    |
| `:redirect`         | Whether to redirect to uploaded files on the storage                              | `false`  |

[download_endpoint]: /lib/shrine/plugins/download_endpoint.rb
[Roda]: https://github.com/jeremyevans/roda
